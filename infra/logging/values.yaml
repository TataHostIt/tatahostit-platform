# --- LOKI CONFIGURATION (Chart 6.49.0 / App v3.6.3) ---
loki:
  deploymentMode: SingleBinary

  # -----------------------------------------------------------
  # FIX: Zero out default "Simple Scalable" components
  # The chart enables these by default (3 replicas each).
  # We must disable them to satisfy the SingleBinary validation.
  # -----------------------------------------------------------
  read:
    replicas: 0
  write:
    replicas: 0
  backend:
    replicas: 0
  # -----------------------------------------------------------

  loki:
    # Critical for Loki 3.x+: Schema v13 is now enforced
    schemaConfig:
      configs:
        - from: "2024-04-01"
          store: tsdb
          object_store: filesystem
          schema: v13
          index:
            prefix: index_
            period: 24h

    commonConfig:
      replication_factor: 1

    storage:
      type: filesystem

    # Retention Logic (Compactor runs inside Single Binary)
    compactor:
      working_directory: /var/loki/compactor
      retention_enabled: true
      # 'shared_store' is deleted in Loki 3.0.
      # Replaced by 'delete_request_store'.
      delete_request_store: filesystem

    limits_config:
      retention_period: 30d

    # Security: Run as non-root (standard for newer charts)
    auth_enabled: false

  # Deployment Configuration
  singleBinary:
    replicas: 1
    persistence:
      enabled: true
      size: 50Gi
      storageClass: sc-fast

    # Pod Security Context for Talos/Ceph
    podSecurityContext:
      fsGroup: 10001
      runAsUser: 10001
      runAsGroup: 10001
      runAsNonRoot: true

  # Configures the ServiceMonitor for Prometheus to scrape Loki metrics
  serviceMonitor:
    enabled: true

  # Disable MinIO (We use filesystem storage)
  minio:
    enabled: false

  # Disable Gateway (Simplify architecture for internal-only use)
  gateway:
    enabled: false

  # Disable the new "Results Cache" deployment to save resources on 4-node cluster
  resultsCache:
    enabled: false

# --- PROMTAIL CONFIGURATION (Chart 6.17.1 / App v3.5.1) ---
promtail:
  # Connection to Loki
  config:
    clients:
      - url: http://logging-stack-loki:3100/loki/api/v1/push

  # TALOS SPECIFIC MOUNTS
  # Talos stores logs in /var/log/pods, but Promtail expects standard K8s paths.
  # We mount the host paths so Promtail can see them.
  extraVolumeMounts:
    - name: varlog
      mountPath: /var/log
      readOnly: true
    - name: varlibdockercontainers
      mountPath: /var/lib/docker/containers
      readOnly: true
    - name: varlogpods
      mountPath: /var/log/pods
      readOnly: true

  # Ensure Promtail runs on ALL nodes (including Control Plane if they run workloads)
  tolerations:
    - operator: Exists