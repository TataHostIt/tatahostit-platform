apiVersion: v1
kind: Service
metadata:
  name: proxmox-exporter
  namespace: monitoring
  labels:
    app: proxmox-exporter
spec:
  ports:
  - port: 9221
    targetPort: 9221
  selector:
    app: proxmox-exporter
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: proxmox-exporter
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: proxmox-exporter
  template:
    metadata:
      labels:
        app: proxmox-exporter
    spec:
      containers:
      - name: proxmox-exporter
        image: prompve/prometheus-pve-exporter:3.7
        ports:
        - containerPort: 9221
        volumeMounts:
        - name: config-volume
          mountPath: /etc/prometheus/pve.yml
          subPath: pve.yml
      # This InitContainer builds the config file using your Sealed Secrets
      initContainers:
      - name: config-builder
        image: busybox
        # FIX: We split the 'user!token' string and write the correct Token config format
        command:
          - sh
          - -c
          - |
            # Split "monitor@pve!monitoring-token" into parts
            # ${VAR%*!} removes the suffix starting with ! (gets the user)
            # ${VAR#*!} removes the prefix ending with ! (gets the token name)
            
            REAL_USER=${PVE_USER%!*}
            TOKEN_NAME=${PVE_USER#*!}
            
            cat <<EOF > /data/pve.yml
            default:
              user: "$REAL_USER"
              token_name: "$TOKEN_NAME"
              token_value: "$PVE_PASSWORD"
              verify_ssl: false
            EOF
        env:
        - name: PVE_USER
          valueFrom:
            secretKeyRef:
              name: monitoring-creds
              key: proxmox-user
        - name: PVE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: monitoring-creds
              key: proxmox-token
        volumeMounts:
        - name: config-volume
          mountPath: /data
      volumes:
      - name: config-volume
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: ipmi-exporter
  namespace: monitoring
  labels:
    app: ipmi-exporter
spec:
  ports:
  - port: 9290
    targetPort: 9290
  selector:
    app: ipmi-exporter
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ipmi-exporter
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ipmi-exporter
  template:
    metadata:
      labels:
        app: ipmi-exporter
    spec:
      containers:
      - name: ipmi-exporter
        # Standard community image for IPMI
        image: prometheuscommunity/ipmi-exporter:v1.10.1
        ports:
        - containerPort: 9290
        args: ["--config.file", "/etc/ipmi/ipmi.yml"]
        volumeMounts:
        - name: config-volume
          mountPath: /etc/ipmi/
      # Build IPMI config on the fly from secrets
      initContainers:
      - name: config-builder
        image: busybox
        command:
          - sh
          - -c
          - |
            cat <<EOF > /data/ipmi.yml
            modules:
              default:
                user: "$IPMI_USER"
                pass: "$IPMI_PASS"
                driver: "lanplus"
                privilege: "operator"
                timeout: 10000
            EOF
        env:
        - name: IPMI_USER
          valueFrom:
            secretKeyRef:
              name: monitoring-creds
              key: ipmi-user
        - name: IPMI_PASS
          valueFrom:
            secretKeyRef:
              name: monitoring-creds
              key: ipmi-pass
        volumeMounts:
        - name: config-volume
          mountPath: /data
      volumes:
      - name: config-volume
        emptyDir: {}